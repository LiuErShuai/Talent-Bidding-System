# 发布方里程碑视图计划
// 不要参考本文档了，直接参考E:\Code\产教融合项目\揭榜挂帅前端\Talent-Bidding-System-master\project_document\[114]发布方里程碑交互设计.md
- **背景**：当前仅承接方具备操作型里程碑体验，发布方缺少专属视图与审核操作，影响项目阶段协同。
- **目标**：基于方案A（详情页新增发布方视图），规划发布方在里程碑环节的展示与交互，实现审批、反馈、沟通的一体化体验。
- **时间戳**：2025-11-27 15:30（修正版）

---

## 目录
1. 现状分析
2. 需求拆解
3. 里程碑范围
4. 发布方视图方案概述（方案A）
5. 详细实现计划（含 Todo List）
6. 依赖与风险

---

## 1. 现状分析

- `project_document/[108]` 中的"项目里程碑"标签页为通用展示，敏感信息仅对参与者可见，但缺少角色差异化操作。
- `project_document/[109]` 已覆盖承接方提交路径（弹窗/独立页面），形成"承接方提交 → 发布方查看"不对等体验。
- 发布方需要：查看承接方提交、审批通过/驳回、追加说明、记录沟通、触发通知；目前只能被动查看数据。

---

## 2. 需求拆解

1. **信息结构**：发布方需一目了然掌握进度概况、提交内容、风险提示、沟通记录。
2. **操作流**：在每个里程碑卡片内提供"通过/驳回/补充意见/再次提醒"等按钮，操作记录需留痕。
3. **入口**：沿用项目详情页 → "项目里程碑"标签页，增加「发布方视图」切换及卡片额外折叠区。
4. **权限区分**：仅 `role===enterprise && userId===publisherId` 可开启操作区；其余保持只读。
5. **通知联动**：审批结果触发消息中心模板，提示承接方下一步动作。
6. **动态审核**：支持多轮审核循环，审核历史根据实际审核轮次动态增加。

---

## 3. 里程碑范围

### 3.1 需要追踪的里程碑

| 序号 | 里程碑名称 | 里程碑代码 | 触发条件 | 完成标准 | 是否可跳过 |
|------|-----------|-----------|---------|---------|-----------|
| 1 | 揭榜征集 | BIDDING | 项目发布后 | 发布方确认揭榜结果 | 否 |
| 2 | 方案提交 | PROPOSAL_SUBMIT | 发布方确认揭榜后 | 发布方审核通过方案 | 否 |
| 3 | 中期答辩 | MIDTERM_DEFENSE | 项目中期节点完成后规定时间 | 发布方评审通过 | 是（发布方控制） |
| 4 | 成果提交 | FINAL_DELIVERY | 承接方主动提交 | 发布方确认验收 | 否 |
| 5 | 成果评审 | FINAL_REVIEW | 成果提交完成后 | 发布方完成评审 | 否 |
| 6 | 结算支付 | PAYMENT | 成果评审完成后 | 发布方确认到账 | 否 |
| 7 | 结项公示 | ANNOUNCEMENT | 结算支付完成后 | 公示期结束无异议 | 否 |

### 3.2 里程碑状态

- **待开始** (`pending`)：里程碑尚未开始或承接方未提交
- **进行中** (`in-progress`)：承接方已提交，待发布方审核
- **已完成** (`completed`)：发布方审核通过，里程碑完成
- **已跳过** (`skipped`)：发布方选择跳过此里程碑（仅适用于可跳过的里程碑）

### 3.3 里程碑依赖关系

里程碑按顺序完成，但允许跳过某些里程碑（仅发布方可控制，如跳过中期答辩）：
```
揭榜征集 → 方案提交 → [中期答辩] → 成果提交 → 成果评审 → 结算支付 → 结项公示
```

---

## 4. 发布方视图方案概述（方案A）

### 4.1 界面结构

- **顶部提示条**：显示当前角色、审批待办数量、风险预警。
- **时间轴卡片**：沿用现有结构，新增「承接方提交摘要」与「发布方操作区」。
- **折叠面板**：包含审核历史、内部备注、沟通对话（仅发布方可新增、承接方只读）。

### 4.2 交互路径

- 项目详情 → 项目里程碑 → 选择里程碑 → 展开"发布方操作区" → 审核/反馈。
- 审核动作为多轮流程（支持多次审核循环），状态回写至里程碑并同步承接方视图。

### 4.3 差异化要点

- **承接方视图**：提交/更新 → 弹窗/独立页面。
- **发布方视图**：查看/审批 → 卡片内操作 + 侧栏沟通。

### 4.4 关键操作二次确认

为防止误操作，以下操作需要二次确认：
- 跳过里程碑（不可逆）
- 确认支付（涉及资金）
- 开始公示（公示开始后不可修改）

---

## 5. 详细实现计划（含 Todo List）

### 5.1 数据拓展

1. **里程碑数据模型扩展**：
   - 定义 `publisherActions`、`reviewHistory`、`riskAlerts` 字段
   - 区分角色可见性（发布方可操作，承接方只读）
   - API 返回时根据角色过滤可修改字段

2. **审核历史数据结构**：
   ```javascript
   {
     reviewId: 'review-001',
     reviewerId: 'enterprise-001',
     reviewerName: '发布方名称',
     reviewTime: '2025-11-27 10:30:00',
     reviewResult: '通过', // '通过' | '驳回' | '要求修改' | '不通过' | '需修订'
     reviewComment: '审核意见内容',
     attachments: [],
     submissionVersion: 1,
     action: '审核方案'
   }
   ```

3. **状态流转机制**：
   - 支持状态流转：`pending` → `in-progress` → `completed` / `pending` / `skipped`
   - 支持多轮审核循环（状态可在 `pending` 和 `in-progress` 之间切换）

### 5.2 界面改造

1. **里程碑卡片增强**：
   - 在里程碑卡片中新增 `roleSwitch` 或自动识别发布方展示操作区
   - 设计"承接方提交摘要"卡片（展示交付物、进度、最近留言）
   - 设计"发布方操作区"按钮组（通过、驳回、提醒、添加备注）

2. **审核弹窗设计**：
   - 左侧固定显示承接方提交内容（只读）
   - 右侧表单输入：结论、评语、附件、是否提醒承接方
   - 支持附件上传（评审意见文档、修改建议清单等）

3. **审核历史列表**：
   - 按时间倒序展示所有审核记录
   - 支持查看历史版本对比
   - 每条记录显示：审核人、时间、结果、意见、附件

4. **跳过里程碑功能**：
   - 仅可跳过的里程碑显示"跳过此里程碑"按钮
   - 点击后弹出跳过确认弹窗（需填写跳过原因，二次确认）
   - 跳过后的里程碑在时间轴上显示"已跳过"标记

### 5.3 交互逻辑

1. **审核流程**：
   - 点击操作按钮 → 弹出审批表单（输入评语、附件、提醒方式）
   - 操作成功后刷新里程碑状态并写入审批历史
   - 触发消息中心（调用消息 API 模块，发送承接方提醒）

2. **多轮审核支持**：
   - 审核历史根据实际审核轮次动态增加
   - 驳回后状态回退，承接方可重新提交
   - 重新提交后状态再次变为 `in-progress`，发布方可再次审核

3. **状态同步**：
   - 承接方提交 → 里程碑状态切为 `in-progress` 并标记"待发布方审核"
   - 发布方操作成功 → 根据结果更新状态并回写至承接方视图
   - 数据同步方式：后端更新后，前端界面刷新即可看到新数据

### 5.4 Todo List

1. **数据层**：
   - [ ] 梳理现有 `project/Detail` 组件结构并标记发布方专属插槽
   - [ ] 定义新增数据字段与 API 调用（包括审批提交接口）
   - [ ] 实现审核历史数据结构与存储逻辑

2. **界面层**：
   - [ ] 设计发布方操作区 UI 草图（含按钮、状态标签、折叠面板）
   - [ ] 实现前端角色判断与条件渲染（发布方操作区）
   - [ ] 开发审批弹窗、历史记录列表、提醒功能
   - [ ] 实现跳过里程碑功能（含二次确认）

3. **交互层**：
   - [ ] 实现审核流程（通过/驳回/要求修改）
   - [ ] 实现多轮审核循环逻辑
   - [ ] 实现状态流转机制
   - [ ] 实现关键操作二次确认

4. **集成层**：
   - [ ] 联调通知/消息中心，校验承接方接收反馈
   - [ ] 实现数据同步机制（后端更新后前端刷新）

5. **测试层**：
   - [ ] 回归测试：包含企业角色、承接方角色、访客三种视角
   - [ ] 测试多轮审核循环场景
   - [ ] 测试跳过里程碑功能
   - [ ] 测试关键操作二次确认

---

## 6. 依赖与风险

### 6.1 依赖

- 项目详情页现有数据加载逻辑
- 消息中心 API
- 承接方提交接口返回的状态字段
- 审核历史存储与查询接口

### 6.2 风险

1. **信息密度提升导致性能压力**：
   - 风险：审核历史、提交历史等数据量大，可能影响页面加载速度
   - 解决方案：按需加载折叠区内容，使用分页或虚拟滚动

2. **权限误判可能泄露内部备注**：
   - 风险：权限判断错误可能导致内部备注泄露给承接方
   - 解决方案：强化前后端双向校验，敏感信息仅发布方可见

3. **通知触发规则需确认**：
   - 风险：通知频次过高可能骚扰用户
   - 解决方案：与运营同学确认频次与模板，避免骚扰

4. **多轮审核可能导致数据混乱**：
   - 风险：多次审核循环可能导致状态混乱
   - 解决方案：严格的状态流转机制，每次审核都记录版本号

5. **跳过里程碑不可逆**：
   - 风险：误操作跳过里程碑后无法恢复
   - 解决方案：关键操作二次确认，明确提示"跳过后不可恢复"

---

**文档结束**
