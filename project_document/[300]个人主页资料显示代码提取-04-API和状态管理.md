# 个人主页资料显示代码提取 - API和状态管理

## 1. user.js - 用户信息管理API

完整的用户信息管理API接口定义。

### 完整源代码

```javascript
/**
 * 用户信息管理相关API
 */
import { authApi, analysisApi } from './index'
import { requestUtils } from './utils'

/**
 * 用户信息管理API接口
 */
export const userAPI = {
  /**
   * 获取用户档案信息
   * @param {string} userId - 用户ID
   * @param {Object} options - 选项
   * @param {boolean} options.include_keywords - 是否包含关键词
   * @returns {Promise} API响应
   */
  getUserProfile: (userId, options = {}) => {
    return analysisApi.post('/profile', {
      user_id: userId,
      include_keywords: options.include_keywords || true
    })
  },

  /**
   * 更新用户基本信息
   * @param {string} userId - 用户ID
   * @param {Object} userData - 用户数据
   * @returns {Promise} API响应
   */
  updateUserInfo: (userId, userData) => {
    return authApi.put(`/users/${userId}`, userData)
  },

  /**
   * 修改用户密码
   * @param {Object} passwordData - 密码数据
   * @param {string} passwordData.current_password - 当前密码
   * @param {string} passwordData.new_password - 新密码
   * @returns {Promise} API响应
   */
  changePassword: (passwordData) => {
    return authApi.put('/auth/password', passwordData)
  },

  /**
   * 获取用户统计数据
   * @param {string} userId - 用户ID
   * @param {Object} params - 查询参数
   * @param {string} params.period - 统计周期 (week/month/year)
   * @returns {Promise} API响应
   */
  getUserStats: (userId, params = {}) => {
    const query = requestUtils.buildQueryString(params)
    return analysisApi.get(`/users/${userId}/stats?${query}`)
  },

  /**
   * 获取用户学习进度
   * @param {string} userId - 用户ID
   * @param {Object} params - 查询参数
   * @returns {Promise} API响应
   */
  getLearningProgress: (userId, params = {}) => {
    const query = requestUtils.buildQueryString(params)
    return analysisApi.get(`/users/${userId}/progress?${query}`)
  },

  /**
   * 获取用户偏好设置
   * @param {string} userId - 用户ID
   * @returns {Promise} API响应
   */
  getUserPreferences: (userId) => {
    return authApi.get(`/users/${userId}/preferences`)
  },

  /**
   * 更新用户偏好设置
   * @param {string} userId - 用户ID
   * @param {Object} preferences - 偏好设置
   * @returns {Promise} API响应
   */
  updateUserPreferences: (userId, preferences) => {
    return authApi.put(`/users/${userId}/preferences`, preferences)
  },

  /**
   * 获取用户活动日志
   * @param {string} userId - 用户ID
   * @param {Object} params - 查询参数
   * @param {number} params.limit - 限制数量
   * @param {number} params.offset - 偏移量
   * @returns {Promise} API响应
   */
  getUserActivityLog: (userId, params = {}) => {
    const query = requestUtils.buildQueryString({
      limit: params.limit || 20,
      offset: params.offset || 0,
      ...params
    })
    return authApi.get(`/users/${userId}/activity?${query}`)
  },

  /**
   * 删除用户账户
   * @param {string} userId - 用户ID
   * @param {string} password - 密码确认
   * @returns {Promise} API响应
   */
  deleteUserAccount: (userId, password) => {
    return authApi.delete(`/users/${userId}`, {
      data: { password }
    })
  }
}

export default userAPI
```

### API使用示例

```javascript
import { userAPI } from '@/api/user'

// 获取用户档案
const getUserProfile = async (userId) => {
  try {
    const response = await userAPI.getUserProfile(userId, {
      include_keywords: true
    })
    console.log('用户档案:', response.data)
    return response.data
  } catch (error) {
    console.error('获取用户档案失败:', error)
    throw error
  }
}

// 更新用户信息
const updateUser = async (userId, userData) => {
  try {
    const response = await userAPI.updateUserInfo(userId, {
      name: userData.name,
      email: userData.email,
      position: userData.position,
      experience: userData.experience
    })
    console.log('更新成功:', response.data)
    return response.data
  } catch (error) {
    console.error('更新用户信息失败:', error)
    throw error
  }
}

// 获取用户统计数据
const getUserStats = async (userId, period = 'month') => {
  try {
    const response = await userAPI.getUserStats(userId, { period })
    console.log('用户统计:', response.data)
    return response.data
  } catch (error) {
    console.error('获取统计数据失败:', error)
    throw error
  }
}
```

## 2. useAuth.js - 认证状态管理（核心部分）

用户认证和状态管理的核心代码，包含用户信息管理。

### 完整源代码

```javascript
import { ref, reactive, computed } from 'vue'
import { authAPI } from '@/api/auth'
import { tokenUtils, errorUtils } from '@/api/utils'
import { ElMessageBox } from 'element-plus'
import router from '@/router'

// 全局状态
const isAuthenticated = ref(false)
const isLoading = ref(false)
let isCheckingAuth = false
const user = reactive({
  user_id: null,
  username: '',
  email: '',
  name: '',
  avatar: '',
  position: '',
  experience: '',
  is_active: false,
  is_verified: false,
  created_at: null,
  last_login_at: null
})

export function useAuthStore() {
  /**
   * 用户登录
   * @param {Object} credentials - 登录凭据
   * @param {string} credentials.email - 邮箱/用户名
   * @param {string} credentials.password - 密码
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  const login = async (credentials) => {
    try {
      isLoading.value = true

      const response = await authAPI.login({
        username: credentials.email,
        password: credentials.password
      })

      const { access_token, refresh_token, user: userData } = response.data

      // 存储token
      tokenUtils.setAccessToken(access_token)
      tokenUtils.setRefreshToken(refresh_token)
      tokenUtils.setUserInfo(userData)

      // 更新用户状态
      isAuthenticated.value = true
      Object.assign(user, userData)

      return { success: true }
    } catch (error) {
      console.error('Login error:', error)
      const errorMessage = errorUtils.extractErrorMessage(error)
      return { success: false, error: errorMessage }
    } finally {
      isLoading.value = false
    }
  }

  /**
   * 用户注册
   * @param {Object} userData - 注册数据
   * @param {string} userData.username - 用户名
   * @param {string} userData.email - 邮箱
   * @param {string} userData.password - 密码
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  const register = async (userData) => {
    try {
      isLoading.value = true

      const response = await authAPI.register({
        username: userData.username || userData.email.split('@')[0],
        email: userData.email,
        password: userData.password
      })

      const { access_token, refresh_token, user: newUser } = response.data

      // 注册成功自动登录
      tokenUtils.setAccessToken(access_token)
      tokenUtils.setRefreshToken(refresh_token)
      tokenUtils.setUserInfo(newUser)

      isAuthenticated.value = true
      Object.assign(user, newUser)

      return { success: true }
    } catch (error) {
      console.error('Register error:', error)
      const errorMessage = errorUtils.extractErrorMessage(error)
      return { success: false, error: errorMessage }
    } finally {
      isLoading.value = false
    }
  }

  /**
   * 清理本地认证状态
   */
  const clearLocalAuth = () => {
    isAuthenticated.value = false
    Object.assign(user, {
      user_id: null,
      username: '',
      email: '',
      name: '',
      avatar: '',
      position: '',
      experience: '',
      is_active: false,
      is_verified: false,
      created_at: null,
      last_login_at: null
    })

    tokenUtils.clearAuth()
  }

  /**
   * 用户登出
   * @returns {Promise<{success: boolean, error?: string}>}
   */
  const logout = async () => {
    try {
      const token = tokenUtils.getAccessToken()
      if (token) {
        await authAPI.logout()
      }

      clearLocalAuth()
      return { success: true }
    } catch (error) {
      console.error('Logout error:', error)
      clearLocalAuth()
      
      if (error.response?.status === 403) {
        return { success: true }
      }

      return {
        success: false,
        error: error.message || '登出失败'
      }
    }
  }

  /**
   * 检查认证状态
   */
  const checkAuth = async () => {
    if (isCheckingAuth) {
      return isAuthenticated.value
    }

    isCheckingAuth = true

    try {
      const token = tokenUtils.getAccessToken()
      const userInfo = tokenUtils.getUserInfo()

      if (!token) {
        isCheckingAuth = false
        return false
      }

      // 如果有本地用户信息，先恢复状态
      if (userInfo) {
        isAuthenticated.value = true
        Object.assign(user, userInfo)
      }

      // 验证token有效性
      try {
        const response = await authAPI.getCurrentUser()
        const currentUser = response.data

        isAuthenticated.value = true
        Object.assign(user, currentUser)
        tokenUtils.setUserInfo(currentUser)

        return true
      } catch (error) {
        console.error('Auth check failed:', error)

        if (error.response?.status === 401 || error.response?.status === 403) {
          clearLocalAuth()
          router.push('/login')
          return false
        }

        await logout()
        return false
      }
    } catch (error) {
      console.error('Check auth error:', error)
      await logout()
      return false
    } finally {
      isCheckingAuth = false
    }
  }

  /**
   * 刷新用户信息
   */
  const refreshUserInfo = async () => {
    try {
      const response = await authAPI.getCurrentUser()
      const currentUser = response.data

      Object.assign(user, currentUser)
      tokenUtils.setUserInfo(currentUser)

      return { success: true }
    } catch (error) {
      console.error('Refresh user info error:', error)
      const errorMessage = errorUtils.extractErrorMessage(error)
      return { success: false, error: errorMessage }
    }
  }

  /**
   * 获取用户ID
   */
  const getUserId = () => {
    return user.user_id || tokenUtils.getUserInfo()?.user_id
  }

  /**
   * 检查用户是否已验证邮箱
   */
  const isEmailVerified = computed(() => user.is_verified)

  /**
   * 检查用户是否激活
   */
  const isUserActive = computed(() => user.is_active)

  // 初始化时检查认证状态
  checkAuth()

  return {
    // 状态
    isAuthenticated: computed(() => isAuthenticated.value),
    isLoading: computed(() => isLoading.value),
    user: computed(() => user),
    isEmailVerified,
    isUserActive,

    // 方法
    login,
    register,
    logout,
    checkAuth,
    refreshUserInfo,
    getUserId
  }
}
```

### 使用示例

```javascript
import { useAuthStore } from '@/composables/useAuth'

// 在组件中使用
export default {
  setup() {
    const authStore = useAuthStore()

    // 访问用户信息
    const user = computed(() => authStore.user)
    const isAuthenticated = computed(() => authStore.isAuthenticated)

    // 刷新用户信息
    const refreshUser = async () => {
      const result = await authStore.refreshUserInfo()
      if (result.success) {
        console.log('用户信息已更新')
      }
    }

    return {
      user,
      isAuthenticated,
      refreshUser
    }
  }
}
```

## 3. 数据模型定义

### 用户数据模型

```javascript
/**
 * 用户基本信息模型
 */
export const UserModel = {
  user_id: String,           // 用户ID
  username: String,          // 用户名
  email: String,             // 邮箱
  name: String,              // 姓名
  avatar: String,            // 头像URL
  position: String,           // 职位
  experience: String,        // 工作经验 (0-1, 1-3, 3-5, 5+)
  is_active: Boolean,        // 是否激活
  is_verified: Boolean,       // 是否已验证邮箱
  created_at: String,         // 创建时间
  last_login_at: String       // 最后登录时间
}

/**
 * 简历数据模型（用于ProfileCard组件）
 */
export const ResumeDataModel = {
  personal_info: {
    name: String,
    email: String,
    phone: String,
    university: String,
    major: String,
    total_experience_years: Number,
    skill_level: String,      // 初级/中级/高级/专家/资深
    expected_salary: String
  },
  direction: String,          // 技术方向
  technical_skills: Array,    // 技术技能数组
  work_experience: Array,     // 工作经验数组
  projects_keywords: Array,   // 项目关键词数组
  education: Array,           // 教育背景数组
  certifications: Array,      // 证书数组
  languages: Array            // 语言能力数组
}
```

---

**继续阅读**: 下一部分包含样式代码和使用指导。

