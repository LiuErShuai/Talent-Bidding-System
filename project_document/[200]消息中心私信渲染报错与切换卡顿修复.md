# 背景与目标

- **背景**：在消息中心新增“私信”后，出现导航切换/按钮点击卡顿，并在控制台报错 `TypeError: Cannot read properties of undefined (reading 'id')`（定位到 `MessageCenter/index.vue` 的列表渲染）。
- **目标**：修复渲染报错根因，降低切换与点击卡顿；保证“通知/私信”两套列表均可稳定渲染与交互。

## 目录

1. 问题现象与影响
2. 根因分析
3. 修复方案
4. 验证清单
5. Todolist（时间戳原则）

## 1. 问题现象与影响

- 导航栏切换卡顿、按钮点击卡顿。
- 控制台报错：
  - `index.vue:125 Uncaught (in promise) TypeError: Cannot read properties of undefined (reading 'id')`
  - 伴随若干渲染/更新错误日志（由首个渲染异常引发连锁报错）。
- 影响：消息列表无法正常渲染，导致页面交互明显卡顿或中断。

## 2. 根因分析

### 根因 1：`filteredNotices` 返回了 `computed` 对象而不是数组

- `noticeList` 被定义为 `computed(...)`，但在 `filteredNotices` 中使用了 `return noticeList`（缺少 `.value`）。
- `v-for="item in filteredNotices"` 得到的不是数组，渲染时出现 `item` 为 `undefined`，触发 `:key="item.id"` 报错。

### 根因 2：频繁同步写入 `localStorage` 导致交互卡顿

- 私信状态 `privateState` 使用 `watch(..., { deep: true })` 直接调用 `localStorage.setItem(...)`。
- localStorage 写入是同步阻塞操作，频繁触发（切换会话、清未读、发送消息等）会造成点击/切换卡顿。

## 3. 修复方案

- 修复 `filteredNotices`：
  - 统一用 `noticeList.value` 获取通知数组，确保 `v-for` 输入稳定为数组。
- 优化私信持久化：
  - 增加 `schedulePersistPrivateState()`，对 `localStorage` 写入做 200ms 轻量节流（`flush: 'post'`），避免高频阻塞主线程。

## 4. 验证清单

- 切换顶部 Tabs（我的消息/收藏关注/评论/回复）不报错不卡顿。
- “我的消息”下切换“私信/系统通知”正常渲染。
- 通知列表点击查看详情正常。
- 私信列表点击会话、发送消息、发起私信弹窗打开正常；交互无明显卡顿。

## 5. Todolist（时间戳原则）

- 2025-12-18 19:52：收集错误日志，定位到 `src/views/message/MessageCenter/index.vue` 的列表渲染 key 读取异常。
- 2025-12-18 19:54：修复 `filteredNotices` 返回值（补充 `.value`），消除 `item.id` 读取异常。
- 2025-12-18 19:55：对 `privateState` 持久化写入增加节流，降低切换与点击卡顿。
- 2025-12-18 19:56：本地启动 `npm run dev`（短暂启动）确认 Vite 可启动，页面可进入（未运行会重写 `dist/` 的构建命令）。
- 2025-12-18 20:00：更新 `project_document/[000]功能模块文档.md` 与 `project_document/[131]交互记忆台账.md`，并创建 Git 提交归档。

